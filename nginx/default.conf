# /etc/nginx/conf.d/default.conf

# 기본 튜닝
proxy_headers_hash_bucket_size 128;
client_max_body_size 20m;           # 업로드 사이즈 필요에 맞게
proxy_read_timeout 60s;
proxy_send_timeout 60s;
sendfile on;

upstream spring_api {
    server springboot-app:8080;    # Spring Boot
    keepalive 32;
}

upstream django_app {
    server django-app:8000;
    keepalive 32;
}

server {
    listen 80;
    server_name _;

    # 공통 헤더(프록시 체인)
    set $forwarded_proto $scheme;

    # 헬스체크
    location = /healthz {
        return 200 'ok';
        add_header Content-Type text/plain;
    }

    # Spring Boot로 프록시: /api/ 이하
    location /api/ {
        proxy_pass http://spring_api/;   # 뒤에 / 중요 (경로 유지)
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $forwarded_proto;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Port   $server_port;

        # WebSocket 필요 시
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Django로 프록시: /django/ 이하
    location /django/ {
        proxy_pass http://django_app/;   # 뒤에 / 중요
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $forwarded_proto;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Port   $server_port;
    }
}
